<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PopSpot — {{ country }}</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    /**
     * Bulma Responsive & Visibility Helpers
     * ──────────────────────────────────────
     * Display helpers: is-flex, is-block, is-inline, is-inline-block, is-inline-flex
     *
     * Breakpoints (Bulma standard):
     * - Mobile: up to 768px
     * - Tablet: 769px to 1023px
     * - Desktop: 1024px to 1215px
     * - Widescreen: 1216px to 1407px
     * - FullHD: 1408px and above
     *
     * Usage examples:
     * - is-hidden-mobile: Hide on mobile only
     * - is-hidden-tablet: Hide on tablet and larger
     * - is-hidden-touch: Hide on mobile and tablet (up to 1023px)
     * - is-flex-mobile: Display as flex on mobile
     * - is-invisible: visibility: hidden (takes up space)
     * - is-hidden: display: none (removes from layout)
     * - is-sr-only: Screen reader only (hidden visually)
     */
    :root {
      --upgrade-accent: #00c897;
      --downgrade-accent: #ff6b6b;
      --monitor-accent: #7b8cde;
      --bg: #0e0f13;
      --surface: #16181f;
      --surface-2: #1e2029;
      --border: #2a2d3a;
      --text-muted: #6b7280;
      --text: #e8eaf0;
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
    }

    /* ── Header ── */
    .site-header {
      padding: 4rem 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .site-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 60% 80% at 50% -20%, rgba(0,200,151,0.10), transparent);
      pointer-events: none;
    }

    .site-title {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: clamp(2rem, 5vw, 3.5rem);
      letter-spacing: -0.03em;
      color: #fff;
      line-height: 1.1;
    }

    .site-subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 0.5rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    /* ── Stat pills ── */
    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.85rem;
      border-radius: 2rem;
      font-size: 0.78rem;
      font-family: 'DM Mono', monospace;
      font-weight: 500;
      border: 1px solid;
    }
    .stat-pill.is-upgrade {
      background: rgba(0,200,151,0.1);
      border-color: rgba(0,200,151,0.35);
      color: var(--upgrade-accent);
    }
    .stat-pill.is-downgrade {
      background: rgba(255,107,107,0.1);
      border-color: rgba(255,107,107,0.35);
      color: var(--downgrade-accent);
    }
    .stat-pill.is-muted {
      border-color: var(--border);
      color: var(--text-muted);
    }

    /* ── Stat pill links ── */
    a.stat-pill {
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    a.stat-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    a.stat-pill.is-upgrade:hover {
      background: rgba(0,200,151,0.15);
      border-color: rgba(0,200,151,0.5);
    }
    a.stat-pill.is-downgrade:hover {
      background: rgba(255,107,107,0.15);
      border-color: rgba(255,107,107,0.5);
    }
    a.stat-pill.is-muted:hover {
      border-color: var(--text-muted);
      color: var(--text);
    }

    /* ── Confidence badges ── */
    .conf-badge {
      display: inline-block;
      padding: 0.15rem 0.55rem;
      border-radius: 4px;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 500;
      white-space: nowrap;
    }
    .conf-badge.is-strong {
      background: rgba(255,160,60,0.15);
      border: 1px solid rgba(255,160,60,0.4);
      color: #ffa03c;
    }
    .conf-badge.is-weak {
      background: rgba(255,220,80,0.1);
      border: 1px solid rgba(255,220,80,0.35);
      color: #e0c040;
    }
    .conf-badge.is-monitor {
      background: rgba(123,140,222,0.12);
      border: 1px solid rgba(123,140,222,0.35);
      color: var(--monitor-accent);
    }

    /* ── Section titles ── */
    .section-title {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 0 0.75rem;
    }
    .section-title .bar {
      flex: none;
      width: 4px;
      height: 1.2em;
      border-radius: 2px;
    }
    .section-title.is-upgrade { color: var(--upgrade-accent); }
    .section-title.is-upgrade .bar { background: var(--upgrade-accent); }
    .section-title.is-downgrade { color: var(--downgrade-accent); }
    .section-title.is-downgrade .bar { background: var(--downgrade-accent); }
    .section-title.is-monitor { color: var(--monitor-accent); }
    .section-title.is-monitor .bar { background: var(--monitor-accent); }

    .section-desc {
      color: var(--text-muted);
      font-size: 0.78rem;
      margin-bottom: 0.85rem;
      line-height: 1.6;
    }

    /* ── Tables ── */
    .table-wrapper {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 3rem;
    }

    .table {
      background: transparent;
      color: var(--text);
      width: 100%;
      margin: 0;
    }

    .table thead th {
      background: var(--surface-2);
      color: var(--text-muted);
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border) !important;
      border-color: transparent !important;
      padding: 0.85rem 1.1rem;
      font-weight: 500;
    }

    .table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .table tbody tr:last-child { border-bottom: none; }
    .table tbody tr:hover { background: var(--surface-2); }

    .table td {
      border-color: transparent !important;
      padding: 0.85rem 1.1rem;
      vertical-align: middle;
      color: var(--text);
    }

    /* ── Cell styles ── */
    .place-badge {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 4px;
      font-size: 0.72rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 500;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .city-name {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: #fff;
    }

    .pop-number {
      font-variant-numeric: tabular-nums;
      font-size: 0.9rem;
    }

    .pct-number {
      font-variant-numeric: tabular-nums;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .pct-number.is-notable { color: var(--text); }

    .rank-cell {
      color: var(--text-muted);
      font-size: 0.78rem;
      width: 2.5rem;
    }

    /* ── Explanation tooltip-style cell ── */
    .explanation-cell {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 340px;
    }

    /* ── OSM link ── */
    .osm-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 0.25rem 0.65rem;
      border-radius: 5px;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }
    .osm-link:hover { color: #fff; border-color: #4a5568; }
    .osm-link svg { flex: none; }

    /* ── Header nav links ── */
    .header-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .header-nav a {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 0.25rem 0.65rem;
      border-radius: 5px;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }
    .header-nav a:hover {
      color: #fff;
      border-color: #4a5568;
    }
    .header-nav svg {
      flex: none;
    }

    /* ── Editor buttons ── */
    .edit-links {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 6rem;
    }
    .edit-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.72rem;
      font-family: 'DM Mono', monospace;
      text-decoration: none;
      padding: 0.22rem 0.6rem;
      border-radius: 4px;
      border: 1px solid;
      transition: opacity 0.15s, filter 0.15s;
      white-space: nowrap;
      line-height: 1.4;
    }
    .edit-btn:hover { opacity: 0.85; filter: brightness(1.15); }
    .edit-btn.is-id {
      background: rgba(124, 179, 66, 0.12);
      border-color: rgba(124, 179, 66, 0.4);
      color: #9ecf55;
    }
    .edit-btn.is-josm {
      background: rgba(66, 153, 225, 0.12);
      border-color: rgba(66, 153, 225, 0.4);
      color: #63b3ed;
    }
    .edit-btn.is-level0 {
      background: rgba(183, 130, 255, 0.12);
      border-color: rgba(183, 130, 255, 0.4);
      color: #c084fc;
    }

    /* ── Plot image ── */
    .plot-section {
      margin-bottom: 3rem;
    }
    .plot-img-wrapper {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      padding: 1rem;
      text-align: center;
    }
    .plot-img-wrapper img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
    }

    /* ── Empty-state ── */
    .empty-state {
      padding: 2.5rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* ── Disclaimer section ── */
    .disclaimer-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 4px solid var(--monitor-accent);
      border-radius: 8px;
      padding: 1.25rem 1.5rem;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .disclaimer-title {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--monitor-accent);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.85rem;
    }

    .disclaimer-title svg {
      flex: none;
      width: 18px;
      height: 18px;
      color: var(--monitor-accent);
    }

    .disclaimer-section p {
      color: var(--text-muted);
      font-size: 0.8rem;
      line-height: 1.7;
      margin: 0;
    }

    /* ── Footer ── */
    .site-footer {
      border-top: 1px solid var(--border);
      padding: 2rem 1.5rem;
      color: var(--text-muted);
      font-size: 0.78rem;
      letter-spacing: 0.04em;
    }

    /* ── Methodology modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .modal-overlay.is-active {
      display: flex;
    }
    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      max-width: 680px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }
    .modal-box h2 {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #fff;
      margin-bottom: 1.25rem;
    }
    .modal-box h3 {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 1.5rem 0 0.5rem;
    }
    .modal-box h3:first-of-type {
      margin-top: 0.25rem;
    }
    .modal-box p {
      color: var(--text-muted);
      font-size: 0.82rem;
      line-height: 1.75;
      margin-bottom: 0.6rem;
    }
    .modal-box p strong {
      color: var(--text);
      font-weight: 500;
    }
    .modal-close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.78rem;
      font-family: 'DM Mono', monospace;
      padding: 0.2rem 0.55rem;
      transition: color 0.15s, border-color 0.15s;
    }
    .modal-close-btn:hover {
      color: #fff;
      border-color: #4a5568;
    }
    .modal-criteria-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin: 0.75rem 0 0.25rem;
    }
    .modal-criteria-table th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 1px solid var(--border);
      padding: 0.3rem 0.6rem 0.3rem 0;
    }
    .modal-criteria-table td {
      color: var(--text);
      padding: 0.35rem 0.6rem 0.35rem 0;
      border-bottom: 1px solid rgba(42,45,58,0.5);
      vertical-align: top;
    }
    .modal-criteria-table td:first-child {
      white-space: nowrap;
    }
    .badge-strong { color: #ffa03c; }
    .badge-weak   { color: #e0c040; }
    .badge-monitor { color: var(--monitor-accent); }

    /* ── Methodology button ── */
    .header-nav button.info-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      font-family: 'DM Mono', monospace;
      color: var(--text-muted);
      background: none;
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 0.25rem 0.65rem;
      border-radius: 5px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
    }
    .header-nav button.info-btn:hover {
      color: #fff;
      border-color: #4a5568;
    }
    @media screen and (max-width: 768px) {
      .header-nav button.info-btn {
        width: 100%;
        justify-content: center;
      }
      .modal-box {
        padding: 1.5rem 1.25rem;
      }
    }

    /* ── Responsive Classes (Bulma-style breakpoints) ── */
    /* Mobile: up to 768px */
    @media screen and (max-width: 768px) {
      .is-hidden-mobile { display: none !important; }
      .is-flex-mobile { display: flex !important; }
      .is-block-mobile { display: block !important; }
      .is-inline-mobile { display: inline !important; }
      .is-inline-flex-mobile { display: inline-flex !important; }

      .site-header {
        padding: 2rem 1rem 1.5rem;
      }

      .site-title {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
      }

      .main-container {
        padding: 0 1rem;
      }

      .header-nav {
        flex-direction: column;
        gap: 0.5rem;
      }

      .header-nav a {
        width: 100%;
        justify-content: center;
      }

      .stat-pill {
        font-size: 0.7rem;
        padding: 0.25rem 0.7rem;
      }

      .section-title {
        font-size: 0.95rem;
      }

      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table {
        min-width: 600px;
      }

      .table td,
      .table th {
        padding: 0.6rem 0.8rem;
        font-size: 0.7rem;
      }

      .explanation-cell {
        max-width: 200px;
        font-size: 0.7rem;
      }

      .edit-links {
        flex-direction: row;
        min-width: unset;
        gap: 0.25rem;
      }

      .edit-btn {
        padding: 0.15rem 0.4rem;
        font-size: 0.65rem;
      }
    }

    /* Tablet: 769px to 1023px */
    @media screen and (min-width: 769px) and (max-width: 1023px) {
      .is-hidden-tablet-only { display: none !important; }
      .is-flex-tablet { display: flex !important; }
      .is-block-tablet { display: block !important; }

      .site-title {
        font-size: clamp(2rem, 4vw, 2.8rem);
      }

      .table td,
      .table th {
        padding: 0.75rem 1rem;
        font-size: 0.75rem;
      }

      .explanation-cell {
        max-width: 280px;
      }
    }

    /* Desktop: 1024px to 1215px */
    @media screen and (min-width: 1024px) and (max-width: 1215px) {
      .is-hidden-desktop-only { display: none !important; }
      .is-flex-desktop { display: flex !important; }
      .is-block-desktop { display: block !important; }
    }

    /* Widescreen: 1216px to 1407px */
    @media screen and (min-width: 1216px) and (max-width: 1407px) {
      .is-hidden-widescreen { display: none !important; }
      .is-flex-widescreen { display: flex !important; }
      .is-block-widescreen { display: block !important; }
    }

    /* FullHD: 1408px and above */
    @media screen and (min-width: 1408px) {
      .is-hidden-fullhd { display: none !important; }
      .is-flex-fullhd { display: flex !important; }
      .is-block-fullhd { display: block !important; }
    }

    /* Touch devices (mobile + tablet) */
    @media screen and (max-width: 1023px) {
      .is-hidden-touch { display: none !important; }
      .is-flex-touch { display: flex !important; }
    }

    /* Visibility helpers */
    .is-invisible { visibility: hidden !important; }
    .is-hidden { display: none !important; }
    .is-sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Responsive ── */
    @media (max-width: 900px) {
      .table thead th.is-hidden-tablet,
      .table td.is-hidden-tablet { display: none; }
    }
  </style>
</head>
<body>

{# ────────────────────────────────────────────────────────────────
   Macros
──────────────────────────────────────────────────────────────── #}

{% macro osm_url(osm_type, osm_id) -%}
  https://www.openstreetmap.org/{{ osm_type }}/{{ osm_id }}
{%- endmacro %}

{# iD editor — uses the long type name (node/way/relation) #}
{% macro id_url(osm_type, osm_id) -%}
  https://www.openstreetmap.org/edit?editor=id&{{ osm_type }}={{ osm_id }}
{%- endmacro %}

{# JOSM remote control — uses single-letter prefix (n/w/r) #}
{% macro josm_url(osm_type, osm_id) -%}
  {%- if osm_type == "node" -%}http://localhost:8111/load_object?objects=n{{ osm_id }}
  {%- elif osm_type == "way" -%}http://localhost:8111/load_object?objects=w{{ osm_id }}
  {%- else -%}http://localhost:8111/load_object?objects=r{{ osm_id }}
  {%- endif -%}
{%- endmacro %}

{# Level0 editor #}
{% macro level0_url(osm_type, osm_id) -%}
  https://level0.osmz.ru/?url={{ osm_type }}/{{ osm_id }}
{%- endmacro %}

{# Renders the three editor buttons for a given osm_type / osm_id #}
{% macro editor_links(osm_type, osm_id) %}
  {% if osm_type and osm_id %}
  <div class="edit-links">
    <a class="edit-btn is-id"
       href="{{ id_url(osm_type, osm_id) }}"
       target="_blank" rel="noopener noreferrer">
      iD
    </a>
    <a class="edit-btn is-josm is-hidden-mobile"
       href="{{ josm_url(osm_type, osm_id) }}"
       title="Requires JOSM with remote control enabled">
      JOSM
    </a>
    <a class="edit-btn is-level0"
       href="{{ level0_url(osm_type, osm_id) }}"
       target="_blank" rel="noopener noreferrer">
      Level0
    </a>
  </div>
  {% else %}—{% endif %}
{% endmacro %}

{% macro conf_badge(confidence) %}
  {% if confidence == "strong" %}
    <span class="conf-badge is-strong">Strong</span>
  {% elif confidence == "weak" %}
    <span class="conf-badge is-weak">Weak</span>
  {% elif confidence == "monitor" %}
    <span class="conf-badge is-monitor">Monitor</span>
  {% endif %}
{% endmacro %}

{# ────────────────────────────────────────────────────────────────
   Data segmentation
──────────────────────────────────────────────────────────────── #}

{% set upgrade_features   = features | selectattr("properties.flag", "equalto", "upgrade")   | list %}
{% set downgrade_features = features | selectattr("properties.flag", "equalto", "downgrade") | list %}
{% set monitor_features   = features | selectattr("properties.confidence", "equalto", "monitor") | list %}

{# Sort upgrade: strong first, then by own_percentile desc #}
{% set upgrade_strong = upgrade_features | selectattr("properties.confidence", "equalto", "strong") | sort(attribute="properties.own_percentile", reverse=true) | list %}
{% set upgrade_weak   = upgrade_features | selectattr("properties.confidence", "equalto", "weak")   | sort(attribute="properties.own_percentile", reverse=true) | list %}
{% set upgrade_sorted = upgrade_strong + upgrade_weak %}

{# Sort downgrade: strong first, then by own_percentile asc #}
{% set downgrade_strong = downgrade_features | selectattr("properties.confidence", "equalto", "strong") | sort(attribute="properties.own_percentile") | list %}
{% set downgrade_weak   = downgrade_features | selectattr("properties.confidence", "equalto", "weak")   | sort(attribute="properties.own_percentile") | list %}
{% set downgrade_sorted = downgrade_strong + downgrade_weak %}

{# Monitor: sort by own_percentile desc (high end is more interesting) #}
{% set monitor_sorted = monitor_features | sort(attribute="properties.own_percentile", reverse=true) | list %}

{# ────────────────────────────────────────────────────────────────
   Header
──────────────────────────────────────────────────────────────── #}
<header class="site-header">
  <div class="container">
    <p class="site-title">PopSpot</p>
    <p class="site-subtitle is-size-3">{{ country }}</p>
    <p class="site-subtitle">OpenStreetMap · place= population tag analysis</p>
    <div style="display:flex; gap:0.6rem; flex-wrap:wrap; margin-top:1.25rem;">
      <a href="#upgrade-section" class="stat-pill is-upgrade is-flex-mobile is-flex-tablet is-flex-desktop">▲ Upgrade candidates &middot; {{ upgrade_sorted | length }}</a>
      <a href="#downgrade-section" class="stat-pill is-downgrade is-flex-mobile is-flex-tablet is-flex-desktop">▼ Downgrade candidates &middot; {{ downgrade_sorted | length }}</a>
      <a href="#monitor-section" class="stat-pill is-muted is-flex-mobile is-flex-tablet is-flex-desktop">◎ Monitor &middot; {{ monitor_sorted | length }}</a>
      <span class="stat-pill is-muted is-flex-mobile is-flex-tablet is-flex-desktop">Generated &middot; {{ generated_at | default("—") }}</span>
    </div>
    <div class="header-nav is-flex-mobile is-flex-tablet is-flex-desktop">
      <a href="../index.html">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2.2"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        Home
      </a>
      <a href="https://github.com/whubsch/popspot" target="_blank" rel="noopener noreferrer">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2.2"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
        </svg>
        GitHub
      </a>
      <button class="info-btn" onclick="document.getElementById('methodology-modal').classList.add('is-active')" aria-haspopup="dialog" aria-controls="methodology-modal">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2.2"
             stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        Methodology
      </button>
    </div>
    <div class="container">
      <div class="disclaimer-section">
        <div class="disclaimer-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Disclaimer
        </div>
        <p>Whether a settlement is a village, town, or city depends on a mix of factors — population, character, local identity, available services, and geographic context — none of which point to a single clear answer. Areas near larger settlements may function as suburbs or neighbourhoods rather than distinct places, while remote settlements often feel more significant than raw numbers suggest. Since reasonable mappers frequently disagree on these judgements, any classification changes should be made thoughtfully and with awareness of local context.</p>
      </div>
    </div>
  </div>
</header>

<main class="container" style="padding: 2.5rem 1.5rem;">

{# ────────────────────────────────────────────────────────────────
   Macro: candidate table
   direction = "upgrade" | "downgrade"
   cross_col_label = label for the percentile-in-adjacent-type column
   cross_attr      = "upgrade_percentile" | "downgrade_percentile"
──────────────────────────────────────────────────────────────── #}
{% macro candidate_table(rows, direction, cross_col_label, cross_attr) %}
{% set is_up = direction == "upgrade" %}
<div class="section-title {{ 'is-upgrade' if is_up else 'is-downgrade' }}" id="{{ 'upgrade-section' if is_up else 'downgrade-section' }}">
  <span class="bar"></span>
  {{ "Upgrade Candidates" if is_up else "Downgrade Candidates" }}
</div>
<p class="section-desc">
  {% if is_up %}
    Places whose population is more consistent with the next-higher type's distribution than their own.
    Ranked by signal strength, then percentile within current type.
  {% else %}
    Places whose population is more consistent with the next-lower type's distribution than their own.
    Ranked by signal strength, then percentile within current type.
  {% endif %}
</p>

<div class="table-wrapper table-container">
  {% if rows %}
  <table class="table is-fullwidth">
    <thead>
      <tr>
        <th style="width:2.5rem;">#</th>
        <th>Name</th>
        <th>Type</th>
        <th>Population</th>
        <th>Own %ile</th>
        <th>{{ cross_col_label }}</th>
        <th>Signal</th>
        <th>Edit</th>
        <th>OSM</th>
      </tr>
    </thead>
    <tbody>
      {% for f in rows %}
      {% set p = f.properties %}
      <tr>
        <td class="rank-cell">{{ loop.index }}</td>
        <td><span class="city-name">{{ p.name if p.name else "—" }}</span></td>
        <td><span class="place-badge">{{ p.place }}</span></td>
        <td>
          <span class="pop-number">{{ "{:,}".format(p.population) }}</span>
        </td>
        <td>
          <span class="pct-number {{ 'is-notable' if (is_up and p.own_percentile >= 75) or (not is_up and p.own_percentile <= 25) else '' }}">
            {{ p.own_percentile | round(0) | int }}%
          </span>
        </td>
        <td>
          {% set cross_val = p[cross_attr] %}
          {% if cross_val is not none %}
          <span class="pct-number {{ 'is-notable' if 20 <= cross_val <= 65 else '' }}">
            {{ cross_val | round(0) | int }}%
          </span>
          {% else %}
          <span class="pct-number">—</span>
          {% endif %}
        </td>
        <td>{{ conf_badge(p.confidence) }}</td>
        <td>{{ editor_links(p.osm_type, p.osm_id) }}</td>
        <td>
          {% if p.osm_type and p.osm_id %}
          <a class="osm-link"
             href="{{ osm_url(p.osm_type, p.osm_id) }}"
             target="_blank"
             rel="noopener noreferrer">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2.2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            {{ p.osm_type }}/{{ p.osm_id }}
          </a>
          {% else %}—{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">No {{ direction }} candidates found in this dataset.</div>
  {% endif %}
</div>
{% endmacro %}

{# ────────────────────────────────────────────────────────────────
   Macro: monitor table
──────────────────────────────────────────────────────────────── #}
{% macro monitor_table(rows) %}
<div class="section-title is-monitor" id="monitor-section">
  <span class="bar"></span>
  Monitor
</div>
<p class="section-desc">
  Places that are consistent with their current type's distribution but sit at an extreme
  percentile within it. No reclassification signal yet, but worth revisiting as more
  population data is tagged.
</p>

<div class="table-wrapper table-container">
  {% if rows %}
  <table class="table is-fullwidth">
    <thead>
      <tr>
        <th style="width:2.5rem;">#</th>
        <th>Name</th>
        <th>Type</th>
        <th>Population</th>
        <th>Own %ile</th>
        <th>Edit</th>
        <th>OSM</th>
      </tr>
    </thead>
    <tbody>
      {% for f in rows %}
      {% set p = f.properties %}
      <tr>
        <td class="rank-cell">{{ loop.index }}</td>
        <td><span class="city-name">{{ p.name if p.name else "—" }}</span></td>
        <td><span class="place-badge">{{ p.place }}</span></td>
        <td><span class="pop-number">{{ "{:,}".format(p.population) }}</span></td>
        <td><span class="pct-number is-notable">{{ p.own_percentile | round(0) | int }}%</span></td>
        <td>{{ editor_links(p.osm_type, p.osm_id) }}</td>
        <td>
          {% if p.osm_type and p.osm_id %}
          <a class="osm-link"
             href="{{ osm_url(p.osm_type, p.osm_id) }}"
             target="_blank"
             rel="noopener noreferrer">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2.2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            {{ p.osm_type }}/{{ p.osm_id }}
          </a>
          {% else %}—{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">No places in the monitor tier.</div>
  {% endif %}
</div>
{% endmacro %}

{# ────────────────────────────────────────────────────────────────
   Render sections
──────────────────────────────────────────────────────────────── #}

{# ────────────────────────────────────────────────────────────────
   Population distribution plot
──────────────────────────────────────────────────────────────── #}
<div class="plot-section">
  <div class="section-title is-muted" style="color: var(--text-muted);">
    <span class="bar" style="background: var(--text-muted);"></span>
    Population Distribution
  </div>
  <p class="section-desc">
    Population distribution by place type for {{ country }}.
    Dots show individual tagged places, with the maximum, minimum, and median population values highlighted.
  </p>
  <div class="plot-img-wrapper">
    <img src="../img/osm_population_plot_{{ country_code }}.png"
         alt="Population distribution plot for {{ country }}" />
  </div>
</div>

{{ candidate_table(upgrade_sorted,   "upgrade",   "%ile among next higher",   "upgrade_percentile") }}
{{ candidate_table(downgrade_sorted, "downgrade", "%ile among next lower", "downgrade_percentile") }}
{{ monitor_table(monitor_sorted) }}

</main>

<footer class="site-footer">
  <div class="container">
    Statistical flags are prompts for investigation, not conclusions. Place hierarchy in OSM reflects
    infrastructure, administrative status, and regional importance — population alone cannot capture that.
    Data sourced from <a href="https://www.openstreetmap.org" target="_blank" rel="noopener"
      style="color:inherit;text-decoration:underline;">OpenStreetMap</a>
    via Overpass API. &copy; OpenStreetMap contributors (ODbL).
    <br><br>
    <a href="https://github.com/whubsch/popspot" target="_blank" rel="noopener noreferrer"
      style="color:inherit;text-decoration:underline;">View on GitHub</a>
  </div>
</footer>

{# ── Methodology modal ── #}
<div id="methodology-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title"
     onclick="if(event.target===this)this.classList.remove('is-active')">
  <div class="modal-box">
    <button class="modal-close-btn" onclick="document.getElementById('methodology-modal').classList.remove('is-active')" aria-label="Close">✕ close</button>
    <h2 id="modal-title">How candidates are ranked</h2>

    <h3>Step 1 — Log-normal distribution fit</h3>
    <p>
      For each place type (city, town, village), a <strong>log-normal distribution</strong> is fitted
      to the population values tagged in OSM. Specifically, the mean and standard deviation of
      <strong>log₁₀(population)</strong> are computed, giving each type its own statistical fingerprint.
    </p>

    <h3>Step 2 — Log-likelihood ratio (LLR)</h3>
    <p>
      Each place is scored under its own type's distribution and under each adjacent type's distribution.
      A <strong>positive LLR</strong> means the place's population fits the neighbouring type's
      distribution better than its own — a statistical signal of potential misclassification.
      If both adjacent types fire simultaneously, the stronger LLR determines the flag direction.
    </p>

    <h3>Step 3 — Percentile corroboration</h3>
    <p>
      The LLR signal is cross-checked against <strong>percentile ranks</strong>: where does this place
      sit within its own type, and where would it land in the target type? Both signals must agree
      for a candidate to be rated Strong.
    </p>

    <h3>Confidence tiers</h3>
    <table class="modal-criteria-table">
      <thead>
        <tr>
          <th>Badge</th>
          <th>Direction</th>
          <th>Criteria (all must hold)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge-strong">Strong</span></td>
          <td>Upgrade</td>
          <td>LLR &gt; 1.0 &nbsp;·&nbsp; own percentile ≥ 75th &nbsp;·&nbsp; target percentile 20–65th</td>
        </tr>
        <tr>
          <td><span class="badge-strong">Strong</span></td>
          <td>Downgrade</td>
          <td>LLR &gt; 1.0 &nbsp;·&nbsp; own percentile ≤ 25th &nbsp;·&nbsp; target percentile 35–80th</td>
        </tr>
        <tr>
          <td><span class="badge-weak">Weak</span></td>
          <td>Either</td>
          <td>LLR &gt; 0, but one or more Strong conditions not met</td>
        </tr>
        <tr>
          <td><span class="badge-monitor">Monitor</span></td>
          <td>—</td>
          <td>No LLR signal, but own percentile ≥ 90th (top) or ≤ 10th (bottom)</td>
        </tr>
      </tbody>
    </table>

    <h3>Why extremes are excluded from Strong</h3>
    <p>
      The target-type percentile window deliberately excludes both tails.
      A place landing <strong>below the 20th percentile</strong> among the target type would be
      marginal even there — a weak fit. A place landing <strong>above the 65th percentile</strong>
      in the target type is unusually large even for that category, suggesting the reclassification
      destination may be wrong (should jump two levels) or the tag is erroneous.
      The middle range confirms the place would be a <em>natural, unremarkable member</em> of the
      target type — the hallmark of a genuine misclassification.
    </p>

    <h3>Table sort order</h3>
    <p>
      Within each section, <span class="badge-strong">Strong</span> candidates always appear before
      <span class="badge-weak">Weak</span> ones. Within each confidence tier, upgrade candidates are
      sorted by <strong>own-type percentile descending</strong> (most overqualified first) and
      downgrade candidates by <strong>own-type percentile ascending</strong> (most underqualified
      first). <span class="badge-monitor">Monitor</span> entries are sorted by own-type percentile
      descending.
    </p>

    <p style="margin-top:1.25rem; font-size:0.75rem;">
      Statistical flags are prompts for investigation, not conclusions. Place hierarchy in OSM
      reflects infrastructure, administrative status, and regional importance — population alone
      cannot capture that.
    </p>
  </div>
</div>

<script>
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('methodology-modal').classList.remove('is-active');
    }
  });
</script>

</body>
</html>
